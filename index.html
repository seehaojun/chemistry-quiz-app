<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ed-Tech Chemistry Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    #quiz, #chat, #leaderboard, #assistant { margin-top: 20px; }
    #chatLog { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 5px; }
    table { width: 100%; border-collapse: collapse; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: left; }
  </style>
  <!-- Include Auth0 SPA JS library -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js"></script>
</head>
<body>
  <h1>Ed-Tech Chemistry Quiz</h1>
  <div id="login">
    <button id="loginBtn">Login / Signup</button>
  </div>
  <div id="app" class="hidden">
    <p>Welcome, <span id="userName"></span> from <span id="userSchool"></span>!</p>
    <!-- Quiz Section -->
    <div id="quiz">
      <h2>Quiz</h2>
      <p id="questionText">Press "New Question" to get started!</p>
      <input type="text" id="answerInput" placeholder="Type your answer here">
      <button id="submitAnswerBtn">Submit Answer</button>
      <button id="newQuestionBtn">New Question</button>
      <p id="feedback"></p>
      <p>Current Score: <span id="currentScore">0</span></p>
      <p>Current Streak: <span id="currentStreak">0</span></p>
    </div>
    <!-- Chat Section -->
    <div id="chat">
      <h2>Chatroom</h2>
      <div id="chatLog"></div>
      <input type="text" id="chatInput" placeholder="Type a message">
      <button id="sendChatBtn">Send</button>
    </div>
    <!-- Leaderboard Section -->
    <div id="leaderboard">
      <h2>Leaderboard</h2>
      <table>
        <thead>
          <tr><th>Rank</th><th>User</th><th>School</th><th>Score</th></tr>
        </thead>
        <tbody id="leaderboardBody">
          <!-- Leaderboard entries go here -->
        </tbody>
      </table>
    </div>
    <!-- AI Assistant for Additional Questions -->
    <div id="assistant">
      <h2>AI Assistant</h2>
      <button id="openAssistantBtn">Ask AI for a new question</button>
      <!-- This button opens ChatGPT in a new tab; you can integrate a custom assistant widget if desired -->
    </div>
  </div>

  <script>
    // Global variables
    let auth0Client = null;
    let userProfile = {};
    let currentScore = 0;
    let currentStreak = 0;
    let currentQuestion = {};
    // For demo, a list of sample questions (in practice, these would be generated by AI)
    const sampleQuestions = [
      { question: "What is the atomic number of Oxygen?", answer: "8" },
      { question: "What is the chemical formula of water?", answer: "H2O" },
      { question: "What gas do plants absorb from the atmosphere?", answer: "CO2" },
      { question: "What is the pH of pure water at 25Â°C?", answer: "7" }
    ];

    // Simulated leaderboard array (in practice, this could be fetched from your backend/Google Sheets)
    let leaderboard = [];

    // Initialize Auth0
    async function initAuth0() {
      auth0Client = await createAuth0Client({
        domain: "dev-mzawkrhazo4fjgnb.us.auth0.com",
        client_id: "1XXSyu4uqn8FzRcxgF4vJQVWO5aTQuTv",
        cacheLocation: 'localstorage',
        useRefreshTokens: true
      });
      
      // Check if the user is already logged in
      if (await auth0Client.isAuthenticated()) {
        userProfile = await auth0Client.getUser();
        document.getElementById("login").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        document.getElementById("userName").innerText = userProfile.nickname || userProfile.name;
        document.getElementById("userSchool").innerText = userProfile['https://example.com/school'] || "Unknown School";
      } else {
        document.getElementById("loginBtn").addEventListener("click", login);
      }
    }

    async function login() {
      await auth0Client.loginWithRedirect({
        redirect_uri: window.location.href
      });
    }

    // Handle Auth0 redirect callback
    async function handleRedirectCallback() {
      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        await auth0Client.handleRedirectCallback();
        // Replace URL with the current pathname to stay in /chemistry-quiz-app/
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // Generate a new quiz question (stubbed with sample questions for now)
    function generateQuestion() {
      currentQuestion = sampleQuestions[Math.floor(Math.random() * sampleQuestions.length)];
      document.getElementById("questionText").innerText = currentQuestion.question;
      document.getElementById("feedback").innerText = "";
      document.getElementById("answerInput").value = "";
    }

    // Handle answer submission
    function submitAnswer() {
      const userAnswer = document.getElementById("answerInput").value.trim();
      if (userAnswer === "") {
        alert("Please enter an answer.");
        return;
      }
      let multiplier = Math.min(1 + currentStreak, 3);
      if (userAnswer.toLowerCase() === currentQuestion.answer.toLowerCase()) {
        currentStreak++;
        const pointsEarned = 10 * multiplier;
        currentScore += pointsEarned;
        document.getElementById("feedback").innerText = `Correct! +${pointsEarned} points.`;
      } else {
        currentStreak = 0;
        document.getElementById("feedback").innerText = `Incorrect. The correct answer was: ${currentQuestion.answer}.`;
      }
      document.getElementById("currentScore").innerText = currentScore;
      document.getElementById("currentStreak").innerText = currentStreak;
      updateLeaderboard(userProfile.nickname || userProfile.name, userProfile['https://example.com/school'] || "Unknown School", currentScore);
      // Save score to Google Sheets
      saveScoreToGoogleSheets(userProfile, currentScore);
    }

    // Update the simulated leaderboard (for demo purposes)
    function updateLeaderboard(user, school, score) {
      const index = leaderboard.findIndex(entry => entry.user === user);
      if (index > -1) {
        leaderboard[index].score = score;
      } else {
        leaderboard.push({ user, school, score });
      }
      leaderboard.sort((a, b) => b.score - a.score);
      renderLeaderboard();
    }

    function renderLeaderboard() {
      const tbody = document.getElementById("leaderboardBody");
      tbody.innerHTML = "";
      leaderboard.forEach((entry, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${index + 1}</td><td>${entry.user}</td><td>${entry.school}</td><td>${entry.score}</td>`;
        tbody.appendChild(row);
      });
    }

    // Send score data to Google Sheets via a Google Apps Script web app endpoint
    function saveScoreToGoogleSheets(user, score) {
      const scriptURL = "https://script.google.com/macros/s/AKfycbw9FgLxENNbVSvbCMfkVi32jsjiAgSWNQOD9A9ZeTr4BjhyTpOT8gacAlCBH3RDiRyl/exec";
      const payload = {
        user: user.nickname || user.name,
        school: user['https://example.com/school'] || "Unknown School",
        score: score,
        timestamp: new Date().toISOString()
      };
      fetch(scriptURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(() => console.log("Score saved to Google Sheets"))
      .catch(error => console.error("Error saving score: ", error));
    }

    // Chat functionality using WebSocket (optional)
    let chatSocket;
    function initChat() {
      const wsUrl = "wss://YOUR_WEBSOCKET_SERVER_URL"; // Replace with your WebSocket server URL if available
      chatSocket = new WebSocket(wsUrl);
      chatSocket.onopen = () => console.log("Connected to chat server.");
      chatSocket.onmessage = event => {
        const chatLog = document.getElementById("chatLog");
        const msgElem = document.createElement("p");
        msgElem.innerText = event.data;
        chatLog.appendChild(msgElem);
        chatLog.scrollTop = chatLog.scrollHeight;
      };
      chatSocket.onerror = error => console.error("Chat error: ", error);
    }

    function sendChatMessage() {
      const message = document.getElementById("chatInput").value;
      if (message.trim() === "") return;
      if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(`${userProfile.nickname || userProfile.name}: ${message}`);
        document.getElementById("chatInput").value = "";
      } else {
        alert("Chat server is not connected.");
      }
    }

    // Event listeners
    document.getElementById("newQuestionBtn").addEventListener("click", generateQuestion);
    document.getElementById("submitAnswerBtn").addEventListener("click", submitAnswer);
    document.getElementById("sendChatBtn").addEventListener("click", sendChatMessage);
    document.getElementById("openAssistantBtn").addEventListener("click", () => {
      window.open("https://chat.openai.com/", "_blank");
    });

    // Initialize app on page load
    window.onload = async () => {
      await handleRedirectCallback();
      await initAuth0();
      if (await auth0Client.isAuthenticated()) {
        initChat(); // Optional: remove if not using a WebSocket server
        generateQuestion();
      }
    };
  </script>
</body>
</html>
